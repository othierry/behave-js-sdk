"use strict";(function(e,t){var n=function(e){var t=this;t.subscribers={},e.forEach(function(e){t.subscribers[e]=[]})};n.prototype.subscribe=function(e,t){var n=this;return n.subscribers[e]&&n.subscribers[e].indexOf(t)===-1?(n.subscribers[e].push(t),!0):!1},n.prototype.unsubscribe=function(e,t){var n=this;if(n.subscribers[e]){var r=n.subscribers[e].indexOf(t);if(r===-1)return!1;n.subscribers[e].slice(r,1)}return!1},n.prototype.publish=function(e,t){var n=this;return n.subscribers[e]?(n.subscribers[e].forEach(function(e){e(t)}),!0):!1};var r=function(e,t){this.referenceId=e,this.points=0,this.anonymous=!0,this.traits=t||{}};r.prototype.isIdentified=function(){return this.referenceId!=null},r.prototype.set=function(e,t){this.traits[e]=t,i.identify(this.referenceId,this.traits)},r.prototype.get-function(e){return this.traits[e]},r.prototype.fetchBadges=function(e){var t=this;if(!i.assertPlayerIsIdentified(e))return;i.requestQueue.push({path:"/players/"+t.referenceId+"/badges"},i.responseHandler(e))},r.prototype.fetchLockedBadges=function(e){var t=this;if(!i.assertPlayerIsIdentified(e))return;i.requestQueue.push({path:"/players/"+t.referenceId+"/badges/todo"},i.responseHandler(e))},r.prototype.fetchLeaderboardResults=function(e,t){var n=this;t=typeof e=="function"?e:t,e=typeof e=="object"?e:{};if(!i.assertPlayerIsIdentified(t))return;e.player_id=n.referenceId,i.requestQueue.push({path:"/leaderboards/player-results",method:"POST",params:e},i.responseHandler(t))},r.prototype.fetchLeaderboardResult=function(e,t,n){var r=this;n=typeof t=="function"?t:n,t=typeof t=="object"?t:{};if(!i.assertPlayerIsIdentified(n))return;t.leaderboards=[e],r.fetchLeaderboardResults(t,function(e,t){n&&n(e,t?t[0]:null)})};if(!e.behave){var i=e.behave={};i.events=new n(["player:identified","reward:points","reward:badge","reward:level"]),i.player=new r(null),i.API_ROOT="http://api.behave.io",i.init=function(e,t){i.token=e,i.options=t||{},i.requestQueue=i.queue(function(e,t){e.params&&(e.method==="POST"||e.method==="PUT")&&(e.params=JSON.stringify(e.params)),jQuery.ajax({url:i.API_ROOT+(typeof e.path=="function"?e.path():e.path),type:e.method||"GET",data:e.params,headers:{"X-Behave-Api-Token":i.token,"Content-Type":"application/json"},xhrFields:{withCredentials:!0}}).done(function(e,n,r){t&&t(null,e)}).fail(function(e,n,r){t&&t(r,null)})}),i.requestQueue.push({path:"/app/info"},i.responseHandler(function(e,t){e?console.error("Failed to fetch app info"):i.app=t}))},i.identify=function(e,t,n){n=typeof t=="function"?t:n,t=typeof t=="object"?t:{};if(!i.assertInitialized(n))return;if(!e){console.log("Error behave.identify() userId cannot be null");return}var r;i.player.anonymous&&i.player.isIdentified()?r={path:function(){return"/players/"+i.player.referenceId+"/reidentify"},method:"POST",params:{new_reference_id:e,traits:t}}:r={path:"/players/"+e+"/identify",method:"POST",params:{traits:t}},i.player.referenceId=e,i.player.anonymous=!1,i.requestQueue.push(r,i.responseHandler(function(e,t){i.player.referenceId=t.reference_id,i.player.traits=t.traits,i.player.level=t.level,i.player.points=t.points,i.events.publish("player:identified",i.player),n&&n(e,t)}))},i.track=function(e,t,n){n=typeof t=="function"?t:n,t=typeof t=="object"?t:null,!n&&i.options.handlesTrackingResponse!==!1&&(n=i.handleTrackingResponse),i.requestQueue.push({path:function(){return i.player.isIdentified()?"/players/"+i.player.referenceId+"/track":"/players/anonymous_track"},method:"POST",params:{verb:e,context:t}},i.responseHandler(function(e,t){!e&&t&&t.is_anonymous&&i.player.anonymous&&(i.player.referenceId=t.player),n&&n(e,t)}))},i.fetchLeaderboardResults=function(e,t,n){n=typeof t=="function"?t:n,t=typeof t=="object"?t:{};if(!i.assertInitialized(n))return;t.limit=t.limit?Math.min(1e3,t.limit):1e3,t.offset=t.page?(t.page-1)*t.limit:0,t.max&&t.max<t.limit&&(t.limit=t.max),i.requestQueue.push({path:"/leaderboards/"+e+"/results",params:t},i.responseHandler(n))},i.iterateLeaderboardResults=function(e,t,n,r){r=typeof t=="function"?n:r,n=typeof t=="function"?t:n,t=typeof t=="object"?t:{};if(!i.assertInitialized(r))return;var s=t.page||1,o=t.limit||1e3,u=t.max||0;i.fetchLeaderboardResults(e,t,function(a,f){if(f){var l=(s-1)*o+f.length,c=f.length===0;c?r&&r():(u>0&&l>u&&(f=f.slice(0,f.length-(l-u)),c=!0),n(f,s),c?r&&r():(t.page=s+1,i.iterateLeaderboardResults(e,t,n,r)))}else r(a)})},i.assertInitialized=function(e){return i.token?!0:(e?e("behave.init(token, options) must be called with a valid token before calling any other methods"):console.error("behave.init(token, options) must be called with a valid token before calling any other methods"),!1)},i.assertPlayerIsIdentified=function(e){return i.assertInitialized(e)&&!i.player.isIdentified()?(e?e("behave.identify() must be called before tracking any of the player's behaviours."):console.error("behave.identify() must be called before tracking any of the player's behaviours."),!1):!0},i.responseHandler=function(e){return function(t,n){if(e){if(t||n.error)return e(t||n.error);e(null,n.data)}}},i.handleTrackingResponse=function(e,t){!e&&t&&(i.player.points=t.points.balance,i.player.level=t.level,t.badges.length&&t.badges.forEach(function(e){i.events.publish("reward:badge",e)}),t.points.earned>0&&i.events.publish("reward:points",t.points),t.level&&t.level.up&&i.events.publish("reward:level",t.level))},i.displayBadgeIfNeeded=function(e,t){!e&&t&&t.badges&&t.badges.length&&i.ui({method:"dialog",badge:t.badges[0],facebook:{link:i.app.url,caption:i.app.name}})},i.queue=function(e){var t=[];return{push:function(e,n){t.push([e,n]),t.length===1&&this.run()},run:function(){if(t.length===0)return;var n=this,r=t[0];e(r[0],function(e,i){r[1]&&r[1](e,i),t=t.slice(1,t.length),n.run()})}}},i.ui=function(t){if(t.method=="dialog")return{showClass:"bounceInDown",hideClass:"bounceOutDown",facebookEnabled:t.facebook&&e.FB,compile:function(){return'<div>  <div class="bh-dialog-backdrop fade"></div>  <div style="text-align:center" class="bh-well bh-dialog">    <div class="bh-legend" style="text-align:center">'+t.badge.name+"</div>"+"    <div>"+'      <img style="margin:auto;display:block" '+'           src="'+t.badge.icon+'" '+'           width="140px" '+'           height="140px" />'+"    </div>"+"    <br>"+"    <p>"+"      "+t.badge.message+"    </p>"+"    <hr>"+(this.facebookEnabled?'<div class="bh-btn bh-btn-facebook" ng-click="shareOnFacebook()"><i class="icon-facebook"></i> | Share</div>':"")+'    <div class="bh-btn" ng-click="close()">'+(this.facebookEnabled?"Or close":"close")+"</div>"+"  </div>"+"</div>"},open:function(){var n=this;n.el=jQuery(n.compile()).appendTo("body"),n.el.children().eq(0).addClass("in"),n.el.children().eq(1).addClass("animated"),n.el.children().eq(1).addClass(n.showClass),n.el.children().eq(1).children().last().click(function(e){e.preventDefault(),n.close()}),n.el.children().eq(1).children().last().prev().click(function(r){e.FB.ui({method:"feed",name:t.badge.name,link:t.facebook.link||"",picture:t.badge.icon,caption:t.facebook.caption||"",description:t.badge.hint},function(r){r&&r.post_id&&(n.isOpen()&&n.close(),e.behave.track("shared badge",{on:"facebook",fb_post_id:r.post_id,badge:t.badge.reference_id}))})})},close:function(){var e=this;e.el.children().eq(0).removeClass("in"),e.el.children().eq(1).removeClass(e.showClass),e.el.children().eq(1).addClass(e.hideClass),setTimeout(function(){e.el.remove()},500)},isOpen:function(){return this.el!=null}}.open()}}})(window,document);